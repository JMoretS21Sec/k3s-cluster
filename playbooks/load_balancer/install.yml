---
- hosts: load_balancer
  gather_facts: yes
  become: no
  roles:
    - role: setup_network_interface
      vars:
        interface: "{{ lb_external_interface }}"
        type: "dhcp"
    - role: setup_network_interface
      vars:
        interface: "{{ lb_internal_interface }}"
        address: "{{ internal_cidr }}"
        type: "manual"
    - role: apt_dependencies
    - role: reboot_and_reconnect
    - role: ntp

- hosts: load_balancer
  gather_facts: yes
  become: no
  roles:
    - role: consul/node
      when: consul.enabled
      vars:
        consul_master: no
        master_list: "{{ groups['master'] | map('extract', hostvars, 'ansible_host') | list }}"

- hosts: load_balancer
  gather_facts: yes
  become: no
  roles:
    - role: haproxy
    - role: keepalived
      vars:
        priority: "{{ lb_priority }}"
        internal_interface: "{{ lb_internal_interface }}"
        internal_floating_ip: "{{ lb_internal_floating_ip }}"
        external_interface: "{{ lb_external_interface }}"
        external_floating_ip: "{{ lb_external_floating_ip }}"
    - role: lb_router_iptables
      vars:
        internal_interface: "{{ lb_internal_interface }}"
        internal_floating_ip: "{{ lb_internal_floating_ip }}"
        internal_ip: "{{ internal_cidr | regex_replace('((?:[0-9]{1,3}\\.){3}[0-9]{1,3})(?:\\/[0-9]{1,2})+', '\\1' ) }}"
        external_interface: "{{ lb_external_interface }}"
        external_floating_ip: "{{ lb_external_floating_ip }}"
    - role: dnsmasq
      vars:
        internal_floating_ip: "{{ lb_internal_floating_ip }}"
        external_floating_ip: "{{ lb_external_floating_ip }}"
...
