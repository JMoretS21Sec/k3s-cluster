---
all:
  vars:
    ansible_user: pi
    # Network domain name. Good practice is using a subdomain of an owned domain name
    # NOTE: DNS resolution using this domain is not yet completely implemented
    #       It's still preferred to rely on avahi .local hostnames
    network_domain: "dmz.example.com"
    # Floating IP configuration
    control_plane_floating_ip: "10.0.0.1"
    # Uncomment to use external datastore HA: https://rancher.com/docs/k3s/latest/en/installation/ha/
#    k3s_datastore_endpoint: 'http://192.168.50.100:2379'
    k3s_token: "somesecrettoken"
    # Uncomment to add additional hostnames or IP as a Subject Alternative Name in the TLS cert
#    k3s_additional_tls_san:
#      - "cluster.example.com"
    # K3S components: https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/#kubernetes-components
    k3s_components:
      coredns: no # We'll install a customised CoreDNS to be able to customise the config and manage it in Flux repository
      servicelb: no # We'll use kube-vip to assign IP addresses to LoadBalancer services
      traefik: no # We'll use nginx-ingress, to maintain control over the installation options (assign the correct IP address to the service)
      local-storage: yes # Local storage is not great for persistent volumes, you should install a better one if possible
      metrics-server: yes
    # We use FluxCD and GitHub to deploy the other components: https://fluxcd.io/docs/
    flux:
      enabled: yes
      version: "0.27.0"
      repository_owner: "febus982"
      repository_name: "k3s-cluster-flux-sample" # You should fork/copy content from https://github.com/febus982/k3s-cluster-flux-sample
      cluster_path: "clusters/k3s-pi"
      github_personal_token: "<personal_token>" # A personal token is necessary, check necessary permissions here: https://fluxcd.io/docs/installation/#github-and-github-enterprise
      github_personal_account: yes # If the repository owner is a GitHub Organisation set this to `no`
      github_teams: # If the repository owner is a GitHub Organisation, you need a list of teams to give maintainer access to
        - infrastructure
    vertical_autoscaler:
      enabled: yes
      version: "0.10.0"
  children:
    k3s_cluster:

k3s_cluster:
  vars:
    # We avoid persisting the SSH host fingerprint to avoid errors caused by the floating IP
    # Jumping between the different Load Balancer Raspberry PIs
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ForwardAgent=yes"
    enable_sda_trim: no
  children:
    master:
    node:

master:
  # Uncomment to add node taints to the master nodes
#  vars:
#    node_taint: "CriticalAddonsOnly=true:NoExecute"
  hosts:
  # List of master node Raspberry PIs and hostnames
    master1:
      ansible_host: master1.local
    master2:
      ansible_host: master2.local
    master3:
      ansible_host: master3.local

node:
  hosts:
    # List of non-master node Raspberry PIs and hostnames
    node1:
      ansible_host: node1.local

...
